<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Training Mode - Smart Racket</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #121212; color: white; padding: 2rem; }
    .form-control, .form-select, .btn { margin-top: 1rem; }
    .live-box { color: #00ff9f; font-size: 1.3rem; margin-top: 1rem; }
    .slider-value { color: #00d9ff; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üèì Training Mode</h2>
    <label>Shot Label:</label>
    <input id="shotLabel" class="form-control" placeholder="e.g. Forehand Drive" />

    <label>Threshold (Gyro Magnitude): <span class="slider-value" id="thresholdValue">150</span></label>
    <input type="range" class="form-range" min="50" max="500" step="10" value="150" id="thresholdSlider" />

    <button class="btn btn-primary" onclick="connectBluetooth()">üîó Connect Bluetooth</button>
    <button class="btn btn-success" onclick="startRecording()">Start Recording</button>
    <button class="btn btn-danger" onclick="stopRecording()">Stop Recording</button>

    <div class="live-box">Live Gyro Speed: <span id="gyroSpeed">0</span></div>
    <div class="mt-3" id="status">Status: <strong>Idle</strong></div>
    <div class="text-success mt-2" id="saveMsg"></div>
  </div>

  <script>
    let bluetoothCharacteristic;
    let isRecording = false;
    let recordedData = [];
    let rawSensorData = [];
    let lastTimestamp = 0;
    let threshold = 150;

    document.getElementById("thresholdSlider").oninput = function () {
      threshold = parseInt(this.value);
      document.getElementById("thresholdValue").textContent = threshold;
    };

    async function connectBluetooth() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: "ESP32" }],
          optionalServices: ["12345678-1234-1234-1234-1234567890ab"]
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService("12345678-1234-1234-1234-1234567890ab");
        bluetoothCharacteristic = await service.getCharacteristic("abcdefab-1234-1234-1234-abcdefabcdef");
        await bluetoothCharacteristic.startNotifications();
        bluetoothCharacteristic.addEventListener("characteristicvaluechanged", handleData);
        document.getElementById("status").innerHTML = "Status: <strong>Connected & Listening</strong>";
      } catch (err) {
        alert("Bluetooth connection failed: " + err.message);
      }
    }

    function handleData(event) {
      const now = Date.now();
      if (now - lastTimestamp < 100) return;
      lastTimestamp = now;

      const value = new TextDecoder().decode(event.target.value);
      const parts = value.split(',').map(Number);
      if (parts.length < 6) return;
      const [ax, ay, az, gx, gy, gz] = parts;

      const gyroMag = Math.sqrt(gx ** 2 + gy ** 2 + gz ** 2);
      document.getElementById("gyroSpeed").textContent = gyroMag.toFixed(1);

      if (gyroMag > threshold && isRecording) {
        rawSensorData.push({ ax, ay, az, gx, gy, gz });

        if (rawSensorData.length >= 5) {
          const means = calcMeans(rawSensorData);
          const variances = calcVariances(rawSensorData, means);
          const sample = { ...means, ...variances, label: document.getElementById("shotLabel").value };
          recordedData.push(sample);
          rawSensorData = [];
        }
      }
    }

    function calcMeans(data) {
      const mean = {};
      ['ax', 'ay', 'az', 'gx', 'gy', 'gz'].forEach(k => {
        mean[k + '_mean'] = data.reduce((sum, d) => sum + d[k], 0) / data.length;
      });
      return mean;
    }

    function calcVariances(data, means) {
      const variance = {};
      ['ax', 'ay', 'az', 'gx', 'gy', 'gz'].forEach(k => {
        variance[k + '_var'] = data.reduce((sum, d) => sum + Math.pow(d[k] - means[k + '_mean'], 2), 0) / data.length;
      });
      return variance;
    }

    function startRecording() {
      recordedData = [];
      isRecording = true;
      document.getElementById("status").innerHTML = "Status: <strong>Recording...</strong>";
      document.getElementById("saveMsg").textContent = "";
    }

    function stopRecording() {
      isRecording = false;
      document.getElementById("status").innerHTML = "Status: <strong>Stopped</strong>";

      fetch("/save_training_data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(recordedData)
      })
      .then(res => res.json())
      .then(data => {
        if (data.message) {
          document.getElementById("saveMsg").textContent = data.message;
        } else {
          alert("Failed to save: " + data.error);
        }
      })
      .catch(err => alert("Error saving training data: " + err.message));
    }
  </script>
</body>
</html>
